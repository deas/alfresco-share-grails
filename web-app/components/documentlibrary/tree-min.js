(function(){var a=YAHOO.util.Dom,x=YAHOO.util.Event;var i=Alfresco.util.combinePaths;Alfresco.DocListTree=function p(y){Alfresco.DocListTree.superclass.constructor.call(this,"Alfresco.DocListTree",y,["treeview","json"]);this.filterId="path";Alfresco.util.FilterManager.register(this.name,this.filterId);this.currentFilter={};this.pathsToExpand=[];YAHOO.Bubbling.on("folderCopied",this.onFolderCopied,this);YAHOO.Bubbling.on("folderCreated",this.onFolderCreated,this);YAHOO.Bubbling.on("folderDeleted",this.onFolderDeleted,this);YAHOO.Bubbling.on("folderMoved",this.onFolderMoved,this);YAHOO.Bubbling.on("folderRenamed",this.onFolderRenamed,this);YAHOO.Bubbling.on("filterChanged",this.onFilterChanged,this);YAHOO.Bubbling.on("dropTargetOwnerRequest",this.onDropTargetOwnerRequest,this);YAHOO.Bubbling.on("documentDragOver",this.onDocumentDragOver,this);YAHOO.Bubbling.on("documentDragOut",this.onDocumentDragOut,this);return this};YAHOO.extend(Alfresco.DocListTree,Alfresco.component.Base,{options:{siteId:"",containerId:"documentLibrary",evaluateChildFolders:true,maximumFolderCount:-1,setDropTargets:false},isReady:false,initialFilter:null,currentPath:"",currentFilter:null,isFilterOwner:false,pathsToExpand:null,selectedNode:null,onReady:function w(){var y=this;Alfresco.util.createTwister(this.id+"-h2",this.name.substring(this.name.lastIndexOf(".")+1));this.fnLoadNodeData=function z(E,B){var C=E.data.path;var D=y._buildTreeNodeUrl.call(y,C);var G={success:function A(K){var J=YAHOO.lang.JSON.parse(K.responseText),L,M;if(J.parent&&E.data.nodeRef.length===0){E.data.nodeRef=J.parent.nodeRef}if(J.items){for(var I=0,H=J.items.length;I<H;I++){L=J.items[I];L.path=i(C,L.name);M=this._buildTreeNode(L,E,false);if(!L.hasChildren){M.isLeaf=true}}}if(J.resultsTrimmed){tempNode=new YAHOO.widget.TextNode({label:"<"+this.msg("message.folders-trimmed")+">",style:"folders-trimmed"},E,false)}K.argument.fnLoadComplete()},failure:function F(K){if(K.status==401){window.location.reload()}else{try{var J=YAHOO.lang.JSON.parse(K.responseText);var I=this.widgets.treeview.getRoot();var H=I.children[0];H.isLoading=false;H.isLeaf=true;H.label=J.message;H.labelStyle="ygtverror";I.refresh()}catch(L){}}},scope:y,argument:{node:E,fnLoadComplete:B}};YAHOO.util.Connect.asyncRequest("GET",D,G)};this._buildTree();this.isReady=true;if(this.initialFilter!==null){this.onFilterChanged("filterChanged",[null,this.initialFilter])}},onDropTargetOwnerRequest:function s(z,y){if(y&&y[1]&&y[1].elementId){var B=this.widgets.treeview.getNodeByElement(a.get(y[1].elementId));if(B!=null){this.onDocumentDragOut(z,y);var A=B.data.nodeRef;var C=B.data.path;y[1].callback.call(y[1].scope,A,C)}}},onDocumentDragOver:function j(B,A){if(A&&A[1]&&A[1].elementId){var F=this.widgets.treeview.getEl();if(A[1].event.clientX>F.clientWidth){}else{var z=a.get(A[1].elementId);if(z!=this.widgets.treeview.getEl()){var E=this.widgets.treeview.getNodeByElement(z);if(E!=null){var y=z;while(y.tagName!="TABLE"){y=y.parentNode}a.addClass(y,"documentDragOverHighlight");var D=z.parentNode.children[z.parentNode.children.length-2];while(D.children.length==1){var C=document.createElement("span");a.addClass(C,"documentDragOverArrow");D.appendChild(C)}}}}}},onDocumentDragOut:function e(C,G){if(G&&G[1]&&G[1].elementId){var F=a.get(G[1].elementId);if(F==this.widgets.treeview.getEl()){var E=a.getElementsByClassName("documentDragOverHighlight","table",F);for(var B=0,A=E.length;B<A;B++){a.removeClass(E[B],"documentDragOverHighlight")}var H=a.getElementsByClassName("documentDragOverArrow","span",F);for(var B=0,A=H.length;B<A;B++){H[B].parentNode.removeChild(H[B])}}else{var z=this.widgets.treeview.getNodeByElement(F);if(z!=null){var D=F;while(D.tagName!="TABLE"){D=D.parentNode}a.removeClass(D,"documentDragOverHighlight");var y=F.parentNode.children[F.parentNode.children.length-2];while(y.children.length>1){y.removeChild(a.getLastChild(y))}}}}},onExpandComplete:function d(z){this.widgets.treeview.render();if(this.isFilterOwner){this._showHighlight(true)}if(this.pathsToExpand&&this.pathsToExpand.length>0){var y=this.widgets.treeview.getNodeByProperty("path",this.pathsToExpand.shift());if(y!==null){if(y.data.path==this.currentPath){this._updateSelectedNode(y)}Alfresco.logger.debug("node.expand: DLT_onExpandComplete");y.expand()}}else{if(this.initialFilter!==null){this.onFilterChanged("filterChanged",[null,{filterId:this.initialFilter.filterId,filterOwner:this.initialFilter.filterOwner,filterData:this.initialFilter.filterData}]);this.initialFilter=null}else{this._applyDropTargets()}}},_applyDropTargets:function g(){if(this.options.setDropTargets){var B=this.widgets.treeview.getEl();new YAHOO.util.DDTarget(B);a.addClass(B,"documentDroppableHighlights");var y=a.getElementsByClassName("ygtvcell","td",B);for(var A=0,z=y.length;A<z;A++){new YAHOO.util.DDTarget(y[A]);a.addClass(y[A],"documentDroppable");a.addClass(y[A],"documentDroppableHighlights")}}},onNodeClicked:function u(y){var z=y.node;if(this.isFilterOwner&&z==this.selectedNode){YAHOO.Bubbling.fire("metadataRefresh")}else{this._updateSelectedNode(z);YAHOO.Bubbling.fire("changeFilter",{filterOwner:this.name,filterId:this.filterId,filterData:z.data.path})}x.stopEvent(y.event);return false},pathChanged:function m(C,y){C=i("/",C);this.currentPath=C;var B=this.widgets.treeview.getNodeByProperty("path",C);if(B!==null){this._updateSelectedNode(B);if(!B.expanded){Alfresco.logger.debug("node.expand: DLT_pathChanged",C);B.expand()}while(B.parent!==null){B=B.parent;if(!B.expanded){Alfresco.logger.debug("node.expand: DLT_onPathChanged (parent)",C);B.expand()}}return}var D=C.split("/"),A="/";if(C==="/"){D=[""]}for(var z=0;z<D.length;z++){A=i(A,D[z]);this.pathsToExpand.push(A)}do{B=this.widgets.treeview.getNodeByProperty("path",this.pathsToExpand.shift())}while(this.pathsToExpand.length>0&&B&&B.expanded);if(B!==null){Alfresco.logger.debug("node.expand: DLT_onPathChanged (pathsToExpand)",this.pathsToExpand);B.expand()}},onFolderRenamed:function q(z,y){var B=y[1];if(B&&(B.file!==null)){var A=this.widgets.treeview.getNodeByProperty("nodeRef",B.file.node.nodeRef);if(A!==null){A.label=B.file.displayName;A.data.path=i(B.file.location.path,B.file.location.file);this.widgets.treeview.render();this._showHighlight(true)}}this._applyDropTargets()},onFolderCopied:function k(z,y){var A=y[1];if(A!==null){if(A.nodeRef&&A.destination){var B=this.widgets.treeview.getNodeByProperty("path",i("/",A.destination));if(B){if(B.expanded){this._sortNodeChildren(B)}else{B.isLeaf=false}}this.widgets.treeview.render();this._showHighlight(true)}}this._applyDropTargets()},onFolderCreated:function n(A,z){var B=z[1];if(B&&(B.parentNodeRef!==null)){var y=this.widgets.treeview.getNodeByProperty("nodeRef",B.parentNodeRef);if(y!==null){this._sortNodeChildren(y)}}this._applyDropTargets()},onFolderDeleted:function t(A,z){var C=z[1];if(C!==null){var B=null;if(C.path){B=this.widgets.treeview.getNodeByProperty("path",i("/",C.path))}else{if(C.nodeRef){B=this.widgets.treeview.getNodeByProperty("nodeRef",C.nodeRef)}}if(B!==null){var y=B.parent;this.widgets.treeview.removeNode(B);if(y!==null){if(!y.hasChildren()){y.isLeaf=true}}this.widgets.treeview.render();this._showHighlight(true)}}this._applyDropTargets()},onFolderMoved:function v(A,z){var C=z[1];if(C!==null){if(typeof C.nodeRef!=="undefined"&&typeof C.destination!=="undefined"){var B=null;B=this.widgets.treeview.getNodeByProperty("nodeRef",C.nodeRef);if(B!==null){var y=B.parent;this.widgets.treeview.removeNode(B,true);if(y!==null){if(!y.hasChildren()){y.isLeaf=true}}var D=this.widgets.treeview.getNodeByProperty("path",i("/",C.destination));if(D){if(!D.isLoading){if(D.isLeaf){D.isLeaf=false}else{if(D.expanded){this._sortNodeChildren(D)}}this.widgets.treeview.render();this._showHighlight(true)}}}}}this._applyDropTargets()},onFilterChanged:function c(z,y){var A=y[1];if((A!==null)&&(A.filterId!==null)){A.filterOwner=A.filterOwner||Alfresco.util.FilterManager.getOwner(A.filterId);if(!this.isReady){this.initialFilter=Alfresco.util.cleanBubblingObject(A);Alfresco.logger.debug("DLT_onFilterChanged (deferring)",this.initialFilter);return}Alfresco.logger.debug("DLT_onFilterChanged",A);this.initialFilter=null;this.currentFilter=Alfresco.util.cleanBubblingObject(A);this.isFilterOwner=(A.filterOwner==this.name);if(this.isFilterOwner){this.pathChanged(this.currentFilter.filterData,A)}this._showHighlight(this.isFilterOwner)}},_buildTree:function f(){var y=new YAHOO.widget.TreeView(this.id+"-treeview");this.widgets.treeview=y;YAHOO.widget.TreeView.FOCUS_CLASS_NAME="";y.setDynamicLoad(this.fnLoadNodeData);var z=y.getRoot();this._buildTreeNode({name:Alfresco.util.message("node.root",this.name),path:"/",nodeRef:""},z,false);y.subscribe("clickEvent",this.onNodeClicked,this,true);y.subscribe("expandComplete",this.onExpandComplete,this,true);y.render()},_sortNodeChildren:function r(B,C){if(B.isLeaf){B.isLeaf=false;this.widgets.treeview.render();this._showHighlight(true);return}var z=B.data.path;var A=this._buildTreeNodeUrl(z);var E={success:function y(I){var M=YAHOO.lang.JSON.parse(I.responseText);if(M.items){var F=I.argument.node.children;var P=M.items;for(var N=0,L=P.length;N<L;N++){if((F.length<=N)||(F[N].data.nodeRef!=P[N].nodeRef)){var G=false;for(var J=N,H=F.length;J<H;J++){if(F[J].data.nodeRef==P[N].nodeRef){var R=F[N];F[N]=F[J];F[J]=R;G=true;break}}if(!G){var S=P[N];S.path=i(I.argument.node.data.path,S.name);var K=this._buildTreeNode(S);if(!S.hasChildren){K.isLeaf=true}if(F.length===0){var O=I.argument.node;O.isLeaf=false;K.appendTo(O)}else{if(F.length>N){K.insertBefore(F[N])}else{K.insertAfter(F[F.length-1])}}}}}this.widgets.treeview.render();this._showHighlight(true);var Q=I.argument.onSortComplete;if(Q&&typeof Q.fn=="function"){Q.fn.call(Q.scope?Q.scope:this,Q.obj)}}},failure:function D(F){Alfresco.logger.error("DLT_sNC_failure",F)},argument:{node:B,onSortComplete:C},scope:this,timeout:7000};YAHOO.util.Connect.asyncRequest("GET",A,E)},_showHighlight:function o(y){if(this.selectedNode!==null){if(y){a.addClass(this.selectedNode.getEl(),"selected")}else{a.removeClass(this.selectedNode.getEl(),"selected")}}},_updateSelectedNode:function l(y){if(this.isFilterOwner){this._showHighlight(false);this.selectedNode=y;this._showHighlight(true)}else{this.selectedNode=y}},_buildTreeNode:function b(y,A,z){return new YAHOO.widget.TextNode({label:y.name,path:y.path,nodeRef:y.nodeRef,description:y.description},A,z)},_buildTreeNodeUrl:function h(y){var z="slingshot/doclib/treenode/site/"+i(encodeURIComponent(this.options.siteId),encodeURIComponent(this.options.containerId),Alfresco.util.encodeURIPath(y));z+="?perms=false&children="+this.options.evaluateChildFolders+"&max="+this.options.maximumFolderCount;return Alfresco.constants.PROXY_URI+z}})})();