(function(){var c=YAHOO.util.Dom,h=YAHOO.util.Event,a=YAHOO.util.Selector;Alfresco.CustomiseDashlets=function(l){Alfresco.CustomiseDashlets.superclass.constructor.call(this,"Alfresco.CustomiseDashlets",l,["button","container","datasource","dragdrop"]);return this};YAHOO.extend(Alfresco.CustomiseDashlets,Alfresco.component.Base,{options:{currentLayout:null,dashboardUrl:null,dashboardId:null},onReady:function d(){this.widgets.addDashletsButton=Alfresco.util.createYUIButton(this,"addDashlets-button",this.onAddDashletsButtonClick);this.widgets.saveButton=Alfresco.util.createYUIButton(this,"save-button",this.onSaveButtonClick);this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel-button",this.onCancelButtonClick);this.widgets.dashletListEl=c.get(this.id+"-column-ul-0");this.widgets.trashcanListEl=c.get(this.id+"-trashcan-img");this.widgets.shadowEl=c.get(this.id+"-dashlet-li-shadow");var o={shadow:this.widgets.shadowEl,draggables:[{container:this.widgets.dashletListEl,groups:[Alfresco.util.DragAndDrop.GROUP_MOVE],cssClass:"availableDashlet",protect:true,duplicatesOnEnterKey:true}],targets:[{container:this.widgets.dashletListEl,group:Alfresco.util.DragAndDrop.GROUP_DELETE},{container:this.widgets.trashcanListEl,group:Alfresco.util.DragAndDrop.GROUP_DELETE}]};var m;for(var l=1;true;l++){m=c.get(this.id+"-column-ul-"+l);if(m){o.draggables.push({container:m,groups:[Alfresco.util.DragAndDrop.GROUP_MOVE,Alfresco.util.DragAndDrop.GROUP_DELETE],cssClass:"usedDashlet"});o.targets.push({container:m,group:Alfresco.util.DragAndDrop.GROUP_MOVE,maximum:5})}else{break}}var n=new Alfresco.util.DragAndDrop(o);YAHOO.Bubbling.on("onDashboardLayoutChanged",this.onDashboardLayoutChanged,this);YAHOO.Bubbling.on("onDashboardLayoutsDisplayed",this.onDashboardLayoutsDisplayed,this);YAHOO.Bubbling.on("onDashboardLayoutsHidden",this.onDashboardLayoutsHidden,this);h.addListener(this.id+"-closeAddDashlets-link","click",this.onCloseAddDashletsLinkClick,this,true);this.widgets.availableDiv=c.get(this.id+"-available-div");this.widgets.toggleDashletsButtonWrapperDiv=c.get(this.id+"-toggleDashletsButtonWrapper-div")},onDashboardLayoutChanged:function k(o,l){var p=l[1].dashboardLayout;this.options.currentLayout=p;var q=c.get(this.id+"-wrapper-div");if(p){for(var n=1;true;n++){var m=c.get(this.id+"-column-div-"+n);if(m){if(n<=p.noOfColumns){c.setStyle(m,"display","")}else{c.setStyle(m,"display","none")}c.removeClass(q,"noOfColumns"+n)}else{break}}c.addClass(q,"noOfColumns"+p.noOfColumns)}else{throw new Error("The argument for event 'onDashboardLayoutChanged' has changed.")}},onDashboardLayoutsDisplayed:function e(m,l){c.setStyle(this.id,"display","none")},onDashboardLayoutsHidden:function g(m,l){c.setStyle(this.id,"display","")},onAddDashletsButtonClick:function f(l){c.setStyle(this.widgets.toggleDashletsButtonWrapperDiv,"display","none");Alfresco.util.Anim.fadeIn(this.widgets.availableDiv)},onCloseAddDashletsLinkClick:function b(l){c.setStyle(this.widgets.toggleDashletsButtonWrapperDiv,"display","");c.setStyle(this.widgets.availableDiv,"display","none");h.stopEvent(l)},onSaveButtonClick:function j(m){this.widgets.saveButton.set("disabled",true);this.widgets.cancelButton.set("disabled",true);var q=[];for(var s=1;s<=this.options.currentLayout.noOfColumns;s++){var t=c.get(this.id+"-column-ul-"+s);var w=c.getElementsByClassName("usedDashlet","li",t);for(var r=0;r<w.length;r++){var v=w[r];if(!c.hasClass(v,"dnd-shadow")){var n={url:a.query("input[type=hidden][name=dashleturl]",v,true).value,regionId:"component-"+s+"-"+(r+1)};var p=a.query("input[type=hidden][name=originalregionid]",v,true);if(p){n.originalRegionId=p.value}q[q.length]=n}}}var u=this.options.dashboardUrl;var o=this.options.currentLayout.templateId;var l={dashboardPage:this.options.dashboardId,templateId:o,dashlets:q};Alfresco.util.Ajax.jsonRequest({method:Alfresco.util.Ajax.POST,url:Alfresco.constants.URL_SERVICECONTEXT+"components/dashboard/customise-dashboard",dataObj:l,successCallback:{fn:function(){document.location.href=Alfresco.constants.URL_PAGECONTEXT+""+u},scope:this},failureMessage:Alfresco.util.message("message.saveFailure",this.name),failureCallback:{fn:function(){this.widgets.feedbackMessage.destroy();this.widgets.saveButton.set("disabled",false);this.widgets.cancelButton.set("disabled",false)},scope:this}});this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.saving",this.name),spanClass:"wait",displayTime:0})},onCancelButtonClick:function i(l){this.widgets.saveButton.set("disabled",true);this.widgets.cancelButton.set("disabled",true);document.location.href=Alfresco.constants.URL_PAGECONTEXT+""+this.options.dashboardUrl}})})();new Alfresco.CustomiseDashlets(null);