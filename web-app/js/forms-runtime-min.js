Alfresco.forms=Alfresco.forms||{};Alfresco.forms.validation=Alfresco.forms.validation||{};(function(){var d=YAHOO.util.Dom,b=YAHOO.util.Event,a=YAHOO.util.Selector,c=YAHOO.util.KeyListener;Alfresco.forms.Form=function(e){this.formId=e;this.validateOnSubmit=true;this.validateAllOnSubmit=false;this.showSubmitStateDynamically=false;this.showSubmitStateDynamicallyErrors=false;this.submitAsJSON=false;this.submitElements=[];this.validations=[];this.ajaxSubmit=false;this.ajaxSubmitMethod="POST";this.errorContainer="alert";return this};Alfresco.forms.Form.prototype={formId:null,submitElements:null,validateOnSubmit:null,validateAllOnSubmit:null,showSubmitStateDynamically:null,showSubmitStateDynamicallyErrors:null,ajaxSubmit:null,errorContainer:null,doBeforeFormSubmit:{fn:function(e,f){},obj:null,scope:this},doBeforeAjaxRequest:{fn:function(e,f){return true},obj:null,scope:this},ajaxSubmitHandlers:null,ajaxSubmitMethod:null,submitAsJSON:null,validations:null,init:function(){var h=d.get(this.formId);if(h!==null){if(h.getAttribute("forms-runtime")!="listening"){b.addListener(h,"submit",this._submitInvoked,this,true);h.setAttribute("forms-runtime","listening");if(this.ajaxSubmit){h.setAttribute("onsubmit","return false;")}}if(h.getAttribute("enctype")&&h.getAttribute("enctype")=="application/json"){this.ajaxSubmit=true;this.submitAsJSON=true}if(this.showSubmitStateDynamically){if(this.submitElements.length==0){var f=a.query("#"+this.formId+' > input[type="submit"]');for(var e=0,i=f.length;e<i;e++){var g=f[e];this.submitElements.push(g.id)}}this.updateSubmitElements()}}else{this._showInternalError("form with id of '"+this.formId+"' could not be located, ensure the form is created after the form element is available.")}},setValidateOnSubmit:function(e){this.validateOnSubmit=e},setValidateAllOnSubmit:function(e){this.validateAllOnSubmit=e},setSubmitElements:function(e){if(!YAHOO.lang.isArray(e)){this.submitElements[0]=e}else{this.submitElements=e}},setErrorContainer:function(e){this.errorContainer=e},setRepeatable:function(f,e){alert("not implemented yet")},setShowSubmitStateDynamically:function(e,f){this.showSubmitStateDynamically=e;if(f){this.showSubmitStateDynamicallyErrors=f}},setAJAXSubmit:function(f,e){this.ajaxSubmit=f;this.ajaxSubmitHandlers=e},setSubmitAsJSON:function(e){this.submitAsJSON=e},setAjaxSubmitMethod:function(e){this.ajaxSubmitMethod=e},addValidation:function(g,h,k,e,i){var j=d.get(g);if(j==null){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Ignoring validation for field with id of '"+g+"' as it could not be located.")}return}if(h===undefined||h===null){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Ignoring validation for field with id of '"+g+"' as a validationHandler was not provided.")}return}if(i===undefined){i=null}var f={fieldId:g,args:k,handler:h,message:i};this.validations.push(f);if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Added submit validation for field: "+g+", using handler: "+(h.name||YAHOO.lang.dump(h))+", args: "+YAHOO.lang.dump(k))}if(e&&e.length>0){b.addListener(j,e,this._validationEventFired,f,this);if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Added field validation for field: "+g+", using handler: "+(h.name||YAHOO.lang.dump(h))+", args: "+YAHOO.lang.dump(k)+", on event: "+e)}}},addError:function(i,g){YAHOO.Bubbling.fire("formValidationError",{msg:i,field:g});if(this.errorContainer!==null){if(this.errorContainer==="alert"){alert(i)}else{var f=d.get(this.errorContainer);if(f!==null){f.style.display="block";var e=f.innerHTML;var h=f.innerHTML+"<div>"+i+"</div>";f.innerHTML=h}}}},addSubmitElement:function(e){if(e!==null){this.submitElements.push(e);this.updateSubmitElements()}},getFieldLabel:function(g){var h=null;var f=a.query("label");if(f.length>0){for(var e=0,j=f.length;e<j;e++){var i=f[e];if(i.htmlFor==g){h=i.firstChild.nodeValue}}}if(h==null){h=g}return h},getFormData:function(){var e=d.get(this.formId);return this._buildAjaxForSubmit(e)},applyTabFix:function(){if(YAHOO.env.ua.gecko>0){var g=d.get(this.formId);var f=function(k,i){var h=i[1];var j=h.target;if(!j.hasAttribute("tabindex")){b.stopEvent(h);a.query("[tabindex]",g)[0].focus()}};var e=new c(g,{keys:c.KEY.TAB},f,"keyup");e.enable()}},updateSubmitElements:function(){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Determining whether submit elements can be enabled...")}var g=this._runValidations(true);for(var e=0,h=this.submitElements.length;e<h;e++){var f=this.submitElements[e];if(f){if(typeof f=="string"){d.get(f).disabled=!g}else{f.set("disabled",!g)}}}},_clearErrors:function(){if(this.errorContainer!=="alert"){var e=d.get(this.errorContainer);if(e!==null){e.style.display="none";e.innerHTML=""}}},_validationEventFired:function(g,f){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Event has been fired for field: "+f.fieldId)}var e=false;if(this.showSubmitStateDynamically){if(this.showSubmitStateDynamicallyErrors){this._clearErrors()}else{e=true}}f.handler(b.getTarget(g),f.args,g,this,e,f.message);if(this.showSubmitStateDynamically){this.updateSubmitElements()}},_submitInvoked:function(j){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Submit invoked on formId: ",this.formId)}this._clearErrors();if(this.validateOnSubmit){var e=false;if(this.showSubmitStateDynamically&&!this.showSubmitStateDynamicallyErrors){e=true}if(this._runValidations(e)){var i=d.get(this.formId);this.doBeforeFormSubmit.fn.call(this.doBeforeFormSubmit.scope,i,this.doBeforeFormSubmit.obj);if(this.ajaxSubmit){b.stopEvent(j);var l=i.attributes.action.nodeValue;if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Performing AJAX submission to url: ",l)}if(i.enctype&&i.enctype=="multipart/form-data"){var k=i.ownerDocument;var h=k.createElement("iframe");h.style.display="none";d.generateId(h,"formAjaxSubmit");h.name=h.id;document.body.appendChild(h);window.frames[h.name].name=h.name;i.target=h.name;i.submit();return}var f={method:this.ajaxSubmitMethod,url:l};if(this.ajaxSubmitHandlers){f=YAHOO.lang.merge(f,this.ajaxSubmitHandlers)}if(this.submitAsJSON){var g=this._buildAjaxForSubmit(i);f.dataObj=g;if(this.doBeforeAjaxRequest.fn.call(this.doBeforeAjaxRequest.scope,f,this.doBeforeAjaxRequest.obj)){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Submitting JSON data: ",f.dataObj)}Alfresco.util.Ajax.jsonRequest(f)}else{if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("JSON data request cancelled in doBeforeAjaxRequest()")}}}else{if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Submitting data in form: ",i.enctype)}f.dataForm=i;Alfresco.util.Ajax.request(f)}}}else{b.stopEvent(j);if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Submission prevented as validation failed")}}}else{if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Ignoring validations as submission validation is disabled")}}},_buildAjaxForSubmit:function(f){if(f!==null){var h={},g=f.elements.length;for(var o=0;o<g;o++){var p=f.elements[o],e=p.name;if(e=="-"||p.disabled||p.type==="button"){continue}if(e==undefined||e==""){e=p.id}var t=(p.type==="textarea")?p.value:YAHOO.lang.trim(p.value);if(e){if((e.length>2)&&(e.substring(e.length-2)=="[]")){e=e.substring(0,e.length-2);if(h[e]===undefined){h[e]=new Array()}h[e].push(t)}else{if(e.indexOf(".")>0){var s=e.split(".");var n=h;var r;for(var m=0,l=s.length-1;m<l;m++){r=s[m];if(n[r]===undefined){n[r]={}}n=n[r]}n[s[m]]=t}else{if(!((p.type==="checkbox"||p.type==="radio")&&!p.checked)){if(p.type=="select-multiple"){for(var m=0,q=p.options.length;m<q;m++){if(p.options[m].selected){if(h[e]==undefined){h[e]=new Array()}h[e].push(p.options[m].value)}}}else{h[e]=t}}}}}}return h}},_runValidations:function(f){var g=false;for(var e=0,j=this.validations.length;e<j;e++){var i=this.validations[e];var h=d.get(i.fieldId);if(h!==null&&!h.disabled){if(!i.handler(h,i.args,null,this,f,i.message)){g=true;if(!this.validateAllOnSubmit){if(!f){h.focus()}break}}}}return !g},_showInternalError:function(f,e){this.addError("Internal Form Error: "+f,e)}}})();(function(){Alfresco.forms.validation.mandatory=function f(z,w,r,s,u,A){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Validating mandatory state of field '"+z.id+"'")}var p=true;if(z.type&&z.type=="radio"){var q=Dom.get(s.formId),v=q[z.name],o=false;for(var y=0,n=v.length;y<n;y++){if(v[y].checked){o=true;break}}p=o}else{p=YAHOO.lang.trim(z.value).length!==0}if(!p&&!u&&s){if(r&&r.keyCode!=9&&r.keyCode!=16||!r){var t=(A!=null)?A:"is mandatory.";s.addError(s.getFieldLabel(z.id)+" "+t,z)}}return p};Alfresco.forms.validation.length=function c(u,t,o,p,s,w){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Validating length of field '"+u.id+"' using args: "+YAHOO.lang.dump(t))}var n=true;var v=YAHOO.lang.merge({min:-1,max:-1,crop:false,includeWhitespace:true},t);if(v.minLength){v.min=v.minLength}if(v.maxLength){v.max=v.maxLength}var q=v.includeWhitespace?u.value.length:YAHOO.lang.trim(u.value).length;if(v.min!=-1&&q<v.min){n=false}if(v.max!=-1&&q>v.max){n=false;if(v.crop){if(v.includeWhitespace){u.value=YAHOO.lang.trim(u.value)}if(u.value.length>v.max){u.value=u.value.substring(0,v.max)}if(u.type&&u.type=="textarea"){u.scrollTop=u.scrollHeight}n=true}}if(!n&&!s&&p){var r=(w!=null)?w:"is not the correct length.";p.addError(p.getFieldLabel(u.id)+" "+r,u)}return n};Alfresco.forms.validation.number=function e(v,u,o,p,t,x){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Validating field '"+v.id+"' is a number")}var r=false;if(u!==null&&u.repeating){r=true}var n=true;if(r){var w=v.value.split(",");for(var s=0;s<w.length;s++){n=(isNaN(w[s])==false);if(!n){break}}}else{n=(isNaN(v.value)==false)}if(!n&&!t&&p){var q=(x!=null)?x:"is not a number.";p.addError(p.getFieldLabel(v.id)+" "+q,v)}return n};Alfresco.forms.validation.numberRange=function m(v,t,o,p,s,x){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Validating number range of field '"+v.id+"' using args: "+YAHOO.lang.dump(t))}var n=true;var w=v.value.toString();if(w.length>0){if(isNaN(w)){n=false;if(!s&&p){var q=(x!=null)?x:"is not a number.";p.addError(p.getFieldLabel(v.id)+" "+q,v)}}else{var r=-1;var u=-1;if(t.min){r=parseInt(t.min)}if(t.minValue){r=parseInt(t.minValue)}if(t.max){u=parseInt(t.max)}if(t.maxValue){u=parseInt(t.maxValue)}if(r!=-1&&w<r){n=false}if(u!=-1&&w>u){n=false}if(!n&&!s&&p){var q=(x!=null)?x:"is not within the allowable range.";p.addError(p.getFieldLabel(v.id)+" "+q,v)}}}return n};Alfresco.forms.validation.nodeName=function j(s,o,r,q,n,p){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Validating field '"+s.id+"' is a valid node name")}if(!o){o={}}o.pattern=/([\"\*\\\>\<\?\/\:\|]+)|([\.]?[\.]+$)/;o.match=false;return Alfresco.forms.validation.regexMatch(s,o,r,q,n,p)};Alfresco.forms.validation.nodeRef=function k(s,o,r,q,n,p){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Validating field '"+s.id+"' is a valid noderef")}if(!o){o={}}o.pattern=/^[^\:^ ]+\:\/\/[^\:^ ]+\/[^ ]+$/;return Alfresco.forms.validation.regexMatch(s,o,r,q,n,p)};Alfresco.forms.validation.email=function h(s,o,r,q,n,p){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Validating field '"+s.id+"' is a valid email address")}if(!o){o={}}o.pattern=/(.+@.+\.[a-zA-Z0-9]{2,6})/;o.match=true;return Alfresco.forms.validation.regexMatch(s,o,r,q,n,p)};Alfresco.forms.validation.time=function d(s,o,r,q,n,p){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Validating field '"+s.id+"' is a valid time value")}if(!o){o={}}o.pattern=/^([0-1]\d|2[0-3]):[0-5]\d(:[0-5]\d)?$/;o.match=true;return Alfresco.forms.validation.regexMatch(s,o,r,q,n,p)};Alfresco.forms.validation.url=function b(v,u,o,p,r,w){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Validating field '"+v.id+"' is a valid URL")}var t=/(ftp|http|https):\/\/[\w\-_]+(\.[\w\-_]+)*([\w\-\.,@?^=%&:/~\+#]*[\w\-\@?^=%&/~\+#])?/,n=true;if(v.value.length>0){var s=new RegExp(t);n=v.value.replace(s,"")==="";if(!n&&!r&&p){var q=(w!=null)?w:"is invalid.";p.addError(p.getFieldLabel(v.id)+" "+q,v)}}return n};Alfresco.forms.validation.regexMatch=function l(u,t,o,p,r,v){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Validating regular expression of field '"+u.id+"' using args: "+YAHOO.lang.dump(t))}var n=true;if(u.value.length>0){if(t.match===undefined){t.match=true}var s=new RegExp(t.pattern);n=s.test(u.value);if(!t.match){n=!n}if(!n&&!r&&p){var q=(v!=null)?v:"is invalid.";p.addError(p.getFieldLabel(u.id)+" "+q,u)}}return n};Alfresco.forms.validation.repoRegexMatch=function i(s,o,r,q,n,p){o.pattern=o.expression;o.match=o.requiresMatch;return Alfresco.forms.validation.regexMatch(s,o,r,q,n,p)};Alfresco.forms.validation.validDateTime=function a(s,o,r,q,n,p){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Validating field '"+s.id+"' has a valid date and time")}return !YAHOO.util.Dom.hasClass(s,"invalid")};Alfresco.forms.validation.inList=function g(s,o,r,q,n,p){return true}})();