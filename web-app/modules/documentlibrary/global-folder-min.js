(function(){var b=YAHOO.util.Dom,B=YAHOO.util.Event,q=YAHOO.util.KeyListener,v=YAHOO.util.Selector;var s=Alfresco.util.encodeHTML,p=Alfresco.util.combinePaths,z=Alfresco.util.hasEventInterest;Alfresco.module.DoclibGlobalFolder=function(C){Alfresco.module.DoclibGlobalFolder.superclass.constructor.call(this,"Alfresco.module.DoclibGlobalFolder",C,["button","container","connection","json","treeview"]);this.containers={};if(C!="null"){this.eventGroup=C;YAHOO.Bubbling.on("siteChanged",this.onSiteChanged,this);YAHOO.Bubbling.on("containerChanged",this.onContainerChanged,this)}return this};var x=Alfresco.module.DoclibGlobalFolder;YAHOO.lang.augmentObject(x,{VIEW_MODE_SITE:0,VIEW_MODE_REPOSITORY:1,VIEW_MODE_USERHOME:2});YAHOO.extend(Alfresco.module.DoclibGlobalFolder,Alfresco.component.Base,{options:{siteId:"",siteTitle:"",containerId:"documentLibrary",containerType:"cm:folder",rootNode:"alfresco://company/home",userHome:"alfresco://user/home",path:"",pathNodeRef:null,width:"60em",files:null,templateUrl:Alfresco.constants.URL_SERVICECONTEXT+"modules/documentlibrary/global-folder",viewMode:x.VIEW_MODE_SITE,allowedViewModes:[x.VIEW_MODE_SITE,x.VIEW_MODE_REPOSITORY,x.VIEW_MODE_USERHOME],evaluateChildFoldersSite:true,maximumFolderCountSite:-1,evaluateChildFoldersRepo:true,maximumFolderCountRepo:-1,siteTreeContainerTypes:{}},containerDiv:null,pathsToExpand:null,selectedNode:null,containers:null,showDialog:function k(){if(!this.containerDiv){Alfresco.util.Ajax.request({url:this.options.templateUrl,dataObj:{htmlid:this.id},successCallback:{fn:this.onTemplateLoaded,scope:this},failureMessage:"Could not load 'global-folder' template:"+this.options.templateUrl,execScripts:true})}else{this._beforeShowDialog()}},onTemplateLoaded:function m(D){var H=this;this.containerDiv=document.createElement("div");this.containerDiv.setAttribute("style","display:none");this.containerDiv.innerHTML=D.serverResponse.responseText;var F=b.getFirstChild(this.containerDiv);this.widgets.dialog=Alfresco.util.createYUIPanel(F,{width:this.options.width});this.widgets.okButton=Alfresco.util.createYUIButton(this,"ok",this.onOK);this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel",this.onCancel);var J=new YAHOO.widget.ButtonGroup(this.id+"-modeGroup");J.on("checkedButtonChange",this.onViewModeChange,this.widgets.modeButtons,this);this.widgets.modeButtons=J;var G=this.widgets.modeButtons.getButtons(),I=function(K){if(q.KEY.ENTER==K.keyCode){this.set("checked",true)}};for(var E=0;E<G.length;E++){G[E].addListener("keydown",I)}this.fnLoadNodeData=function C(O,L){var M=O.data.path;var N=H._buildTreeNodeUrl.call(H,M);var Q={success:function K(U){var T=Alfresco.util.parseJSON(U.responseText);if(T.parent){if(O.data.nodeRef.indexOf("alfresco://")===0){O.data.nodeRef=T.parent.nodeRef}if(typeof O.data.userAccess=="undefined"){O.data.userAccess=T.parent.userAccess;O.setUpLabel({label:O.label,style:T.parent.userAccess.create?"":"no-permission"})}}if(T.items){var V,W;for(var S=0,R=T.items.length;S<R;S++){V=T.items[S];W=new YAHOO.widget.TextNode({label:s(V.name),path:p(M,V.name),nodeRef:V.nodeRef,description:V.description,userAccess:V.userAccess,style:V.userAccess.create?"":"no-permission"},O,false);if(!V.hasChildren){W.isLeaf=true}}if(T.resultsTrimmed){W=new YAHOO.widget.TextNode({label:"&lt;"+this.msg("message.folders-trimmed")+"&gt;",style:"folders-trimmed"},O,false)}}U.argument.fnLoadComplete()},failure:function P(U){try{var T=YAHOO.lang.JSON.parse(U.responseText);var S=this.widgets.treeview.getRoot();var R=S.children[0];R.isLoading=false;R.isLeaf=true;R.label=T.message;R.labelStyle="ygtverror";S.refresh()}catch(V){}},scope:H,argument:{node:O,fnLoadComplete:L},timeout:7000};YAHOO.util.Connect.asyncRequest("GET",N,Q)};this._beforeShowDialog()},_beforeShowDialog:function r(){if(this.options.pathNodeRef){var C=Alfresco.constants.PROXY_URI+"slingshot/doclib/node/"+this.options.pathNodeRef.uri+"/location";if(this.options.rootNode){C+="?libraryRoot="+encodeURIComponent(this.options.rootNode.toString())}Alfresco.util.Ajax.jsonGet({url:C,successCallback:{fn:function(E){if(E.json!==undefined){var D=E.json;if(D.site){this.options.viewMode=x.VIEW_MODE_SITE;this.options.path=p(D.site.path,D.site.file);this.options.siteId=D.site.site;this.options.siteTitle=D.site.siteTitle}else{this.options.viewMode=x.VIEW_MODE_REPOSITORY;this.options.path=p(D.repo.path,D.repo.file);this.options.siteId=null;this.options.siteTitle=null}this._showDialog()}},scope:this},failureMessage:this.msg("message.failure")})}else{this._showDialog()}},_showDialog:function o(){this.widgets.okButton.set("disabled",false);this.widgets.cancelButton.set("disabled",false);var G=b.get(this.id+"-title");if(this.options.title){G.innerHTML=this.options.title}else{if(YAHOO.lang.isArray(this.options.files)){G.innerHTML=this.msg("title.multi",this.options.files.length)}else{G.innerHTML=this.msg("title.single",'<span class="light">'+s(this.options.files.displayName)+"</span>")}}var C=Alfresco.util.arrayToObject(this.options.allowedViewModes),H=this.widgets.modeButtons.getButtons(),I,E;if(!(this.options.viewMode in C)){this.options.viewMode=this.options.allowedViewModes[0]}for(var D=0,F=H.length;D<F;D++){I=H[D];E=parseInt(I.get("name"),10);I.set("disabled",!(E in C));I.setStyle("display",E in C?"block":"none");if(E==this.options.viewMode){if(I.get("checked")){this.setViewMode(E)}else{I.set("checked",true)}}}if(!this.widgets.escapeListener){this.widgets.escapeListener=new q(document,{keys:q.KEY.ESCAPE},{fn:function(K,J){this.onCancel()},scope:this,correctScope:true})}this.widgets.escapeListener.enable();this.widgets.dialog.show()},setViewMode:function i(C){this.options.viewMode=C;if(C==x.VIEW_MODE_SITE){b.removeClass(this.id+"-wrapper","repository-mode");this._populateSitePicker()}else{b.addClass(this.id+"-wrapper","repository-mode");this._buildTree(C==x.VIEW_MODE_USERHOME?this.options.userHome:this.options.rootNode);this.onPathChanged(this.options.path?this.options.path:"/")}},onSiteChanged:function y(H,F){if(z(this,F)){var J=F[1];if(J!==null){if(J.site!==null){this.options.siteId=J.site;this.options.siteTitle=J.siteTitle;this._populateContainerPicker();var I=v.query("a",this.id+"-sitePicker"),E,G,D,C=b.get(this.id+"-sitePicker");for(G=0,D=I.length;G<D;G++){E=I[G];if(E.getAttribute("rel")==J.site){b.addClass(E,"selected");if(J.scrollTo){C.scrollTop=b.getY(E)-b.getY(C)}}else{b.removeClass(E,"selected")}}}}}},onContainerChanged:function f(H,F){if(z(this,F)){var J=F[1];if(J!==null){if(J.container!==null){this.options.containerId=J.container;this.options.containerType=this.containers[J.container].type;this._buildTree(this.containers[J.container].nodeRef);this.onPathChanged(this.options.path);var I=v.query("a",this.id+"-containerPicker"),C,G,E,D=b.get(this.id+"-containerPicker");for(G=0,E=I.length;G<E;G++){C=I[G];if(C.getAttribute("rel")==J.container){b.addClass(C,"selected");if(J.scrollTo){D.scrollTop=b.getY(C)-b.getY(D)}}else{b.removeClass(C,"selected")}}}}}},onOK:function j(D,E){this.widgets.escapeListener.disable();this.widgets.dialog.hide();var C=this.selectedNode?this.selectedNode.data:null;if(C&&this.options.viewMode==x.VIEW_MODE_SITE){C.siteId=this.options.siteId;C.siteTitle=this.options.siteTitle;C.containerId=this.options.containerId}YAHOO.Bubbling.fire("folderSelected",{selectedFolder:C,eventGroup:this})},onCancel:function a(C,D){this.widgets.escapeListener.disable();this.widgets.dialog.hide()},onViewModeChange:function l(E,F){var D=this.options.viewMode;try{D=parseInt(E.newValue.get("name"),10);this.setViewMode(D)}catch(C){}},onExpandComplete:function h(F){Alfresco.logger.debug("DLGF_onExpandComplete");this.widgets.treeview.render();this._showHighlight(true);if(this.pathsToExpand&&this.pathsToExpand.length>0){var E=this.widgets.treeview.getNodeByProperty("path",this.pathsToExpand.shift());if(E!==null){var D=E.getContentEl(),C=b.get(this.id+"-treeview");C.scrollTop=b.getY(D)-(C.scrollHeight/3);if(E.data.path==this.currentPath){this._updateSelectedNode(E)}E.expand()}}},onNodeClicked:function u(D){Alfresco.logger.debug("DLGF_onNodeClicked");var F=D.event,E=D.node,C=E.data.userAccess;if((C&&C.create)||(E.data.nodeRef=="")||(E.data.nodeRef.indexOf("alfresco://")===0)){this.onPathChanged(E.data.path);this._updateSelectedNode(E)}B.preventDefault(F);return false},onPathChanged:function d(G){Alfresco.logger.debug("DLGF_onPathChanged:"+G);if(G.charAt(0)!="/"){G="/"+G}this.currentPath=G;var F=this.widgets.treeview.getNodeByProperty("path",G);if(F!==null){this._updateSelectedNode(F);F.expand();while(F.parent!==null){F=F.parent;F.expand()}return}var H=G.split("/"),E="/";if(G==="/"){H=[""]}this.pathsToExpand=[];for(var D=0,C=H.length;D<C;D++){E=p("/",E,H[D]);this.pathsToExpand.push(E)}Alfresco.logger.debug("DLGF_onPathChanged paths to expand:"+this.pathsToExpand.join(","));do{F=this.widgets.treeview.getNodeByProperty("path",this.pathsToExpand.shift())}while(this.pathsToExpand.length>0&&F.expanded);if(F!==null){F.expand()}},_populateSitePicker:function w(){var D=b.get(this.id+"-sitePicker"),G=this;D.innerHTML="";var F=function C(J,N){var O=J.json,L,H,M,K,Q=null;var P=function I(R){return function(){YAHOO.Bubbling.fire("siteChanged",{site:R.shortName,siteTitle:R.title,eventGroup:G});return false}};if(O.length>0){Q=O[0]}for(M=0,K=O.length;M<K;M++){H=O[M];L=document.createElement("div");if(M==K-1){b.addClass(L,"last")}L.innerHTML='<a rel="'+H.shortName+'" href="#""><h4>'+s(H.title)+"</h4><span>"+s(H.description)+"</span></a>";L.onclick=P(H);N.appendChild(L)}YAHOO.Bubbling.fire("siteChanged",{site:(this.options.siteId&&this.options.siteId.length>0)?this.options.siteId:Q.shortName,siteTitle:(this.options.siteId&&this.options.siteId.length>0)?this.options.siteTitle:Q.title,eventGroup:this,scrollTo:true})};var E={url:Alfresco.constants.PROXY_URI+"api/sites",responseContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:F,scope:this,obj:D},failureCallback:null};Alfresco.util.Ajax.request(E)},_populateContainerPicker:function e(){var I=b.get(this.id+"-containerPicker"),F=this;I.innerHTML="";var E=function C(L,Q){var K=L.json.containers,N,J,O,M;this.containers={};var R=function P(S){return function(){YAHOO.Bubbling.fire("containerChanged",{container:S,eventGroup:F});return false}};for(O=0,M=K.length;O<M;O++){J=K[O];this.containers[J.name]=J;N=document.createElement("div");if(O==M-1){b.addClass(N,"last")}N.innerHTML='<a rel="'+J.name+'" href="#"><h4>'+J.name+"</h4><span>"+J.description+"</span></a>";N.onclick=R(J.name);Q.appendChild(N)}YAHOO.Bubbling.fire("containerChanged",{container:this.options.containerId,eventGroup:this,scrollTo:true})};var H=function G(L){try{var K=this.widgets.treeview.getRoot(),J=K.children[0];J.isLoading=false;J.isLeaf=true;J.label=this.msg("message.error");J.labelStyle="ygtverror";K.refresh()}catch(M){}I.innerHTML=""};var D={url:Alfresco.constants.PROXY_URI+"slingshot/doclib/containers/"+this.options.siteId,responseContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:E,scope:this,obj:I},failureCallback:{fn:H,scope:this}};Alfresco.util.Ajax.request(D)},_buildTree:function g(F){Alfresco.logger.debug("DLGF__buildTree");var C=new YAHOO.widget.TreeView(this.id+"-treeview");this.widgets.treeview=C;YAHOO.widget.TreeView.FOCUS_CLASS_NAME="";C.setDynamicLoad(this.fnLoadNodeData);var D="location.path.repository";if(this.options.viewMode==x.VIEW_MODE_SITE){var E=this.options.siteTreeContainerTypes[this.options.containerType]||{};D=E.rootLabel||"location.path.documents"}else{if(this.options.viewMode==x.VIEW_MODE_USERHOME){D="location.path.userHome"}}var G=new YAHOO.widget.TextNode({label:this.msg(D),path:"/",nodeRef:F},C.getRoot(),false);C.subscribe("clickEvent",this.onNodeClicked,this,true);C.subscribe("expandComplete",this.onExpandComplete,this,true);C.render()},_showHighlight:function n(C){Alfresco.logger.debug("DLGF__showHighlight");if(this.selectedNode!==null){if(C){b.addClass(this.selectedNode.getEl(),"selected")}else{b.removeClass(this.selectedNode.getEl(),"selected")}}},_updateSelectedNode:function t(C){Alfresco.logger.debug("DLGF__updateSelectedNode");this._showHighlight(false);this.selectedNode=C;this._showHighlight(true)},_buildTreeNodeUrl:function c(E){var F=Alfresco.constants.PROXY_URI;if(this.options.viewMode==x.VIEW_MODE_SITE){var C=this.options.siteTreeContainerTypes[this.options.containerType]||{};if(C.uri){F+=C.uri}else{F+="slingshot/doclib/treenode/site/{site}/{container}{path}";F+="?children={evaluateChildFoldersSite}";F+="&max={maximumFolderCountSite}"}}else{if(this.options.viewMode==x.VIEW_MODE_USERHOME){F+="slingshot/doclib/treenode/node/{userHome}{path}";F+="?children={evaluateChildFoldersRepo}"}else{F+="slingshot/doclib/treenode/node/alfresco/company/home{path}";F+="?children={evaluateChildFoldersRepo}";F+="&libraryRoot={rootNode}"}F+="&max={maximumFolderCountRepo}"}var D=YAHOO.lang.substitute(F,{site:encodeURIComponent(this.options.siteId),container:encodeURIComponent(this.options.containerId),rootNode:this.options.rootNode,userHome:(this.options.userHome||"").replace(":/",""),path:Alfresco.util.encodeURIPath(E),evaluateChildFoldersSite:this.options.evaluateChildFoldersSite+"",maximumFolderCountSite:this.options.maximumFolderCountSite,evaluateChildFoldersRepo:this.options.evaluateChildFoldersRepo+"",maximumFolderCountRepo:this.options.maximumFolderCountRepo});return D}});var A=new Alfresco.module.DoclibGlobalFolder("null")})();