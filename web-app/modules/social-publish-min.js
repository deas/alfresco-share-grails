(function(){var b=YAHOO.util.Dom,v=YAHOO.util.Event,s=YAHOO.util.Selector,p=YAHOO.util.KeyListener;Alfresco.module.socialPublishing=function(y){this.name="Alfresco.module.socialPublishing";this.id=y;var x=Alfresco.util.ComponentManager.get(this.id);if(x!==null){throw new Error("An instance of Alfresco.module.socialPublishing already exists.")}Alfresco.util.ComponentManager.register(this);Alfresco.util.YUILoaderHelper.require(["button","container"],this.onComponentsLoaded,this);return this};Alfresco.module.socialPublishing.prototype={defaultShowConfig:{nodeRef:null,filename:null},showConfig:{},widgets:{},updateLimits:{},onComponentsLoaded:function e(){if(this.id===null){return}},setUpdateLimits:function m(x){this.updateLimits=x;return this},show:function u(x){this.showConfig=YAHOO.lang.merge(this.defaultShowConfig,x);if(this.showConfig.nodeRef===undefined||this.showConfig.filename===undefined){throw new Error("A nodeRef & filename must be provided")}if(this.widgets.panel){this.widgets.panel.destroy}Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"modules/social-publishing?nodeRef="+this.showConfig.nodeRef+"&htmlid="+this.id,successCallback:{fn:this.onTemplateLoaded,scope:this},failureMessage:Alfresco.util.message("socialPublish.template.error",this.name),execScripts:true});this.widgets.escapeListener=new p(document,{keys:p.KEY.ESCAPE},{fn:this.onCancelButtonClick,scope:this,correctScope:true})},onTemplateLoaded:function d(x){if(x.serverResponse.responseText.indexOf(this.id)===-1){Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("socialPublish.noChannels")});return}var z=document.createElement("div");z.innerHTML=x.serverResponse.responseText;var y=YAHOO.util.Dom.getFirstChild(z);this.widgets.panel=Alfresco.util.createYUIPanel(y);this.widgets.panel.nodeRef=this.showConfig.nodeRef;this.widgets.selectChannelButton=new YAHOO.widget.Button(this.id+"-channel-select-button",{type:"menu",menu:this.id+"-publishChannel-menu",lazyloadmenu:false});this.widgets.selectStatusUpdateChannels=new YAHOO.widget.Button(this.id+"-statusSelect-button",{type:"menu",menu:this.id+"-statusSelect-menu",lazyloadmenu:false});this.widgets.headerText=b.get(this.id+"-header-span");this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel-button",this.onCancelButtonClick);this.widgets.publishButton=Alfresco.util.createYUIButton(this,"publish-button",this.onPublishButtonClick);this.widgets.formContainer=b.get(this.id+"-publish-form");this.widgets.statusUpdateText=b.get(this.id+"-statusUpdate-text");this.widgets.statusUpdateCount=b.get(this.id+"-statusUpdate-count");this.widgets.statusUpdateCountMsg=b.get(this.id+"-statusUpdate-countMessage");this.widgets.statusUpdateChannelCount=b.get(this.id+"-statusUpdate-channel-count");this.widgets.statusUpdateCountURL=b.get(this.id+"-statusUpdate-count-urlMessage");this.widgets.statusUpdateCheckboxes=b.getElementsByClassName("statusUpdate-checkboxes","input",this.widgets.formContainer);this.widgets.statusUpdateUrlCheckbox=b.get(this.id+"-statusUpdate-checkbox-url");v.addListener(this.widgets.statusUpdateText,"keydown",this.onStatusUpdateKeypress,{},this);v.addListener(this.widgets.statusUpdateText,"keyup",this.onStatusUpdateKeypress,{},this);v.addListener(this.widgets.statusUpdateCheckboxes,"click",this.onStatusCheckboxToggle,{},this);v.addListener(b.get(this.id+"-publishChannel-menu"),"click",this.onSelectPublishChannel,{},this);v.addListener(b.get(this.id+"-statusSelectActionAll"),"click",this.onSelectAllStatusChannels,{},this);v.addListener(b.get(this.id+"-statusSelectActionNone"),"click",this.onSelectNoStatusChannels,{},this);v.addListener(this.widgets.statusUpdateUrlCheckbox,"click",this.onStatusURLToggle,{},this);this._showPanel()},onCancelButtonClick:function k(){this.closeDialogue()},onPublishButtonClick:function l(){var x=this.widgets.selectChannelButton.get("value"),B={channelId:x,publishNodes:[this.showConfig.nodeRef],statusUpdate:{}},A=this,z=[];includeStatus=false;for(var y=0;y<this.widgets.statusUpdateCheckboxes.length;y++){if(this.widgets.statusUpdateCheckboxes[y].checked){z.push(this.widgets.statusUpdateCheckboxes[y].value);includeStatus=true}}if(includeStatus){B.statusUpdate={message:this.widgets.statusUpdateText.value,channelIds:z};if(this.widgets.statusUpdateUrlCheckbox.checked){B.statusUpdate.nodeRef=this.showConfig.nodeRef}}var D=function C(F){var G=Alfresco.util.ComponentManager.findFirst("Alfresco.DocumentPublishing");if(G!==null){G.doRefresh()}var I=A.showConfig.filename,E=this.widgets.selectChannelButton.getAttributeConfig("label").value,H=Alfresco.constants.URL_PAGECONTEXT+"document-details?nodeRef="+A.showConfig.nodeRef;linkText=Alfresco.util.message("socialPublish.confirm.link",A.name,{"0":I}),linkHTML="<a href='"+H+"'>"+linkText+"</a>",channelHTML="<span class='channel'>"+E+"</span>",trackingText=Alfresco.util.message("socialPublish.confirm.track",A.name,{"0":linkHTML}),successText=Alfresco.util.message("socialPublish.confirm.success",A.name,{"0":I,"1":channelHTML}),balloonHTML="<div class='publishConfirm'><div class='success'>"+successText+"</div><div class='tracking'>"+trackingText+"</div></div>",doclib=Alfresco.util.ComponentManager.findFirst("Alfresco.DocumentList");balloonElement=(doclib)?b.get(doclib.id):b.getElementsByClassName("document-thumbnail")[0];balloon=Alfresco.util.createBalloon(balloonElement,{html:balloonHTML,width:"48em"});balloon.show();YAHOO.lang.later(10000,this,function(){balloon.hide()})};Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"api/publishing/queue",method:Alfresco.util.Ajax.POST,requestContentType:"application/json",responseContentType:"application/json",dataObj:B,successCallback:{fn:D,scope:this},failureMessage:Alfresco.util.message("socialPublish.confirm.failure",this.name)});this.closeDialogue()},closeDialogue:function w(){this.resetTruncationMsg();this.widgets.panel.hide();this.widgets.escapeListener.disable()},onStatusUpdateKeypress:function q(){this.checkUpdateLength()},onStatusCheckboxToggle:function r(x){Alfresco.util.toggleClass(b.getAncestorByClassName(v.getTarget(x),"status-channel"),"selected");this.onSelectedStatusChannelChange()},onSelectAllStatusChannels:function f(z){for(var x in this.widgets.statusUpdateCheckboxes){var y=this.widgets.statusUpdateCheckboxes[x];y.checked=true;b.addClass(b.getAncestorByClassName(y,"status-channel"),"selected")}this.onSelectedStatusChannelChange();v.preventDefault(z)},onSelectNoStatusChannels:function n(z){for(var x in this.widgets.statusUpdateCheckboxes){var y=this.widgets.statusUpdateCheckboxes[x];y.checked=false;b.removeClass(b.getAncestorByClassName(y,"status-channel"),"selected")}this.onSelectedStatusChannelChange();v.preventDefault(z)},onSelectedStatusChannelChange:function a(){this.resetTruncationMsg();this.checkUpdateLength();var x=s.filter(this.widgets.statusUpdateCheckboxes,":checked").length;this.widgets.statusUpdateChannelCount.innerHTML=Alfresco.util.message("socialPublish.dialogue.statusUpdate.select.count",this.name,{"0":x,"1":this.widgets.statusUpdateCheckboxes.length});if(x>0){this.widgets.statusUpdateText.removeAttribute("disabled");this.widgets.statusUpdateUrlCheckbox.removeAttribute("disabled")}else{b.setAttribute(this.widgets.statusUpdateText,"disabled","disabled");b.setAttribute(this.widgets.statusUpdateUrlCheckbox,"disabled","disabled")}},onStatusURLToggle:function o(){this.checkUpdateLength()},onSelectPublishChannel:function i(y,z){var x=v.getTarget(y);if(!s.test(x,"a.publishChannel")){x=b.getAncestorByClassName(x,"publishChannel")}this.widgets.selectChannelButton.set("label",x.innerHTML);this.widgets.selectChannelButton.set("value",x.rel);v.preventDefault(y)},checkUpdateLength:function h(){var z=null,D=0,y=0,F=s.filter(this.widgets.statusUpdateCheckboxes,":checked"),C={};if(F.length>0){for(var A=0;A<F.length;A++){var x=parseInt(b.getAttribute(F[A],"rel"),10),B=b.getAttribute(F[A],"name");if(x>0&&(x<z||z===null)){z=x}if(C[B]===undefined&&x!==0){C[B]=x}}if(z!==null){if(this.widgets.statusUpdateUrlCheckbox.checked){var G=parseInt(b.getAttribute(this.widgets.statusUpdateUrlCheckbox,"rel"),10);D=D+G;this.widgets.statusUpdateCountURL.innerHTML=Alfresco.util.message("socialPublish.dialogue.statusUpdate.urlChars",this.name,{"0":G})}else{this.widgets.statusUpdateCountURL.innerHTML=""}D=D+this.widgets.statusUpdateText.value.length;y=z-D;this.widgets.statusUpdateCount.innerHTML=Alfresco.util.message("socialPublish.dialogue.statusUpdate.charsRemaining",this.name,{"0":y});this.widgets.statusUpdateCountMsg.innerHTML=Alfresco.util.message("socialPublish.dialogue.statusUpdate.countMessage",this.name);if(y<0){b.addClass(b.getAncestorByClassName(this.widgets.statusUpdateCount,"statusUpdate-count-container","div"),"warning");var E=[];for(var A in C){if(parseInt(C[A],10)<D){E.push(A)}}this.showTruncationMsg(E)}else{this.resetTruncationMsg();b.removeClass(b.getAncestorByClassName(this.widgets.statusUpdateCount,"statusUpdate-count-container","div"),"warning")}}else{this.widgets.statusUpdateCount.innerHTML=this.widgets.statusUpdateCountURL.innerHTML=""}}else{this.widgets.statusUpdateCount.innerHTML=this.widgets.statusUpdateCountURL.innerHTML=this.widgets.statusUpdateCountMsg=""}},showTruncationMsg:function j(y){if(this.widgets.truncationNotification===null||this.widgets.truncationNotification.truncationChannels.length!==y.length){this.resetTruncationMsg();var x=(y.length>1)?"plural":"singular";this.widgets.truncationNotification=Alfresco.util.createBalloon(this.widgets.statusUpdateText,{text:Alfresco.util.message("socialPublish.dialogue.statusUpdate.truncationMessage."+x,this.name,{"0":y.join(", ")}),width:"24em"});this.widgets.truncationNotification.truncationChannels=y;this.widgets.truncationNotification.show()}},resetTruncationMsg:function t(){if(this.widgets.truncationNotification){this.widgets.truncationNotification.hide()}this.widgets.truncationNotification=null},_applyConfig:function c(){var x=Alfresco.util.message("socialPublish.dialogue.header",this.name,{"0":"<strong>"+this.showConfig.filename+"</strong>"});this.widgets.headerText.innerHTML=x;this.widgets.cancelButton.set("disabled",false)},_showPanel:function g(){this._applyConfig();this.widgets.escapeListener.enable();this.widgets.panel.show()}}})();Alfresco.module.getSocialPublishingInstance=function(){var a="alfresco-socialPublishing-instance";return Alfresco.util.ComponentManager.get(a)||new Alfresco.module.socialPublishing(a)};